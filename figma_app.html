<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding-bottom: 50px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ìƒë‹¨ í—¤ë” */
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .header-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-icon {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-online {
            background: #4CAF50;
        }

        .status-offline {
            background: #f44336;
        }

        /* íƒ­ */
        .tabs-container {
            display: flex;
            gap: 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f0f0f0;
            border: none;
            border-right: 1px solid #e0e0e0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: 0.3s;
        }

        .tab-button:last-child {
            border-right: none;
        }

        .tab-button:hover {
            background: #e8e8e8;
        }

        .tab-button.active {
            background: white;
            color: #2196F3;
            border-bottom: 3px solid #2196F3;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* ì¹´ë©”ë¼ ì„¹ì…˜ */
        .camera-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .camera-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .camera-container {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-stream {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            color: white;
        }

        .btn-sale {
            background: #FF6B6B;
        }

        .btn-sale:hover {
            background: #FF5252;
        }

        .btn-impossible {
            background: #FF0000;
        }

        .btn-impossible:hover {
            background: #CC0000;
        }

        /* ê°ì§€ëª©ë¡ */
        .detection-list {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .list-header {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .message-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f5f5f5;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
            font-size: 13px;
        }

        .message-class {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .message-time {
            font-size: 12px;
            color: #999;
        }

        .message-confidence {
            font-size: 12px;
            color: #666;
        }

        /* í•˜ë‹¨ ë°°ë„ˆ */
        .bottom-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #FFD700;
            color: #333;
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 -1px 3px rgba(0,0,0,0.1);
        }

        .bottom-banner.online {
            background: #4CAF50;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <div class="header-title">ì†Œ ê´€ë¦¬ ì‹œìŠ¤í…œ ğŸ„</div>
            <div class="status-bar">
                <div class="status-item">
                    ğŸ“Š DB: 4ë§ˆë¦¬
                </div>
                <div class="status-item">
                    <span class="status-icon status-online" id="camera-status"></span>
                    ê°ì§€: <span id="detection-count">0</span>ê±´
                </div>
                <div class="status-item">
                    <span class="status-icon status-offline" id="supabase-status"></span>
                    Supabase: <span id="supabase-connected">ë¯¸ì—°ê²°</span>
                </div>
            </div>
        </div>

        <!-- íƒ­ ë²„íŠ¼ -->
        <div class="tabs-container">
            <button class="tab-button active" onclick="switchTab('camera')">
                ğŸ“· ì‹¤ì‹œê°„ ì¹´ë©”ë¼
            </button>
            <button class="tab-button" onclick="switchTab('detection')">
                ğŸ“‹ ê°ì§€ëª©ë¡ (0)
            </button>
        </div>

        <!-- ì¹´ë©”ë¼ íƒ­ -->
        <div class="tab-pane active" id="camera-pane">
            <div class="camera-section">
                <div class="camera-label">
                    <span>ğŸ“·</span>
                    ì‹¤ì‹œê°„ ì¹´ë©”ë¼
                </div>

                <div class="camera-container">
                    <img id="camera-stream"
                         class="camera-stream"
                         src="http://10.9.2.130:5000/video_feed"
                         alt="ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼"
                         onerror="showCameraError()">
                </div>

                <div class="button-group">
                    <button class="btn btn-sale" onclick="detectSale()">ğŸ›ï¸ íŒë§¤</button>
                    <button class="btn btn-impossible" onclick="detectImpossible()">âŒ ë¶ˆê°€ëŠ¥</button>
                </div>
            </div>
        </div>

        <!-- ê°ì§€ëª©ë¡ íƒ­ -->
        <div class="tab-pane" id="detection-pane">
            <div class="detection-list">
                <div class="list-header">ğŸ“‹ ê°ì§€ëœ í•­ëª©</div>
                <div id="message-container">
                    <div class="empty-state">
                        <div>ê°ì§€ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ë°°ë„ˆ -->
    <div class="bottom-banner" id="bottom-banner">
        ğŸŸ¡ Supabase ì—°ê²° ì¤‘...
    </div>

    <script>
        // â­ Supabase ì„¤ì •
        const SUPABASE_URL = 'https://cnwvsiniftozuompjlwk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNud3ZzaW5pZnRvenVvbXBqbHdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNjQ1MTksImV4cCI6MjA3Nzg0MDUxOX0.KTHJP5BE-NAWlhdzcVPgqZoVDZ2LLQQmFg0FY9vfRa8';

        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let isConnected = false;
        let lastDetectionId = -1;

        // íƒ­ ì „í™˜
        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tab + '-pane').classList.add('active');

            if (tab === 'detection') {
                loadDetections();
            }
        }

        // Supabase ì—°ê²° í™•ì¸
        async function checkSupabaseConnection() {
            try {
                const { data, error } = await supabase
                    .from('detections')
                    .select('count')
                    .limit(1)
                    .single();

                if (!error) {
                    isConnected = true;
                    document.getElementById('supabase-status').className = 'status-icon status-online';
                    document.getElementById('supabase-connected').textContent = 'ì—°ê²°ë¨';
                    document.getElementById('bottom-banner').textContent = 'âœ… Supabase ì—°ê²°ë¨ | ì‹¤ì‹œê°„ ê°ì§€ ì¤‘';
                    document.getElementById('bottom-banner').classList.add('online');

                    // ì‹¤ì‹œê°„ ê°ì§€ ì‹œì‘
                    subscribeToDetections();

                    return true;
                }
            } catch (error) {
                console.error('Supabase ì—°ê²° ì‹¤íŒ¨:', error);
            }

            isConnected = false;
            document.getElementById('supabase-status').className = 'status-icon status-offline';
            document.getElementById('supabase-connected').textContent = 'ë¯¸ì—°ê²°';
            document.getElementById('bottom-banner').textContent = 'ğŸ”´ Supabase ë¯¸ì—°ê²°';
            document.getElementById('bottom-banner').classList.remove('online');

            return false;
        }

        // ì‹¤ì‹œê°„ ê°ì§€ êµ¬ë…
        function subscribeToDetections() {
            supabase
                .channel('detections')
                .on(
                    'postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'detections' },
                    (payload) => {
                        const detection = payload.new;
                        addDetectionToUI(detection);
                        updateDetectionCount();
                    }
                )
                .subscribe();
        }

        // ê°ì§€ ê²°ê³¼ ë¡œë“œ
        async function loadDetections() {
            try {
                const { data, error } = await supabase
                    .from('detections')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(50);

                if (error) throw error;

                const container = document.getElementById('message-container');

                if (data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div>ê°ì§€ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = '';
                    data.forEach(detection => {
                        addDetectionToUI(detection);
                    });
                }

                updateDetectionCount();
            } catch (error) {
                console.error('ê°ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // UIì— ê°ì§€ ì¶”ê°€
        function addDetectionToUI(detection) {
            const container = document.getElementById('message-container');

            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }

            const item = document.createElement('div');
            item.className = 'message-item';
            item.innerHTML = `
                <div class="message-class">âš¡ ${detection.class.toUpperCase()}</div>
                <div class="message-confidence">ì‹ ë¢°ë„: ${detection.confidence}%</div>
                <div class="message-time">${new Date(detection.timestamp).toLocaleString('ko-KR')}</div>
            `;

            container.insertBefore(item, container.firstChild);

            // ìµœëŒ€ 50ê°œë§Œ ìœ ì§€
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        // ê°ì§€ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        async function updateDetectionCount() {
            try {
                const { count, error } = await supabase
                    .from('detections')
                    .select('*', { count: 'exact', head: true });

                if (!error) {
                    document.getElementById('detection-count').textContent = count || 0;
                    document.querySelectorAll('.tab-button')[1].textContent = `ğŸ“‹ ê°ì§€ëª©ë¡ (${count || 0})`;
                }
            } catch (error) {
                console.error('ê°œìˆ˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }

        // ì¹´ë©”ë¼ ì—ëŸ¬ ì²˜ë¦¬
        function showCameraError() {
            const container = document.querySelector('.camera-container');
            container.innerHTML = `
                <div style="text-align: center; color: #999;">
                    <div style="font-size: 60px; margin-bottom: 10px;">ğŸ“·</div>
                    <div>ì¹´ë©”ë¼ê°€ êº¼ì ¸ìˆìŠµë‹ˆë‹¤</div>
                    <div style="font-size: 12px; margin-top: 10px;">PyCharmì—ì„œ detection_streaming_server.pyë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”</div>
                </div>
            `;
            document.getElementById('camera-status').className = 'status-icon status-offline';
        }

        // íŒë§¤ ê°ì§€
        async function detectSale() {
            try {
                const { error } = await supabase
                    .from('detections')
                    .insert([{
                        class: 'sale',
                        confidence: 100,
                        type: 'manual',
                        timestamp: new Date().toISOString()
                    }]);

                if (!error) {
                    alert('âœ… íŒë§¤ ê°ì§€ë¨!');
                    loadDetections();
                    updateDetectionCount();
                } else {
                    alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
                }
            } catch (error) {
                alert('âš ï¸ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            }
        }

        // ë¶ˆê°€ëŠ¥ ê°ì§€
        async function detectImpossible() {
            try {
                const { error } = await supabase
                    .from('detections')
                    .insert([{
                        class: 'impossibility',
                        confidence: 100,
                        type: 'manual',
                        timestamp: new Date().toISOString()
                    }]);

                if (!error) {
                    alert('âœ… ë¶ˆê°€ëŠ¥ ê°ì§€ë¨!');
                    loadDetections();
                    updateDetectionCount();
                } else {
                    alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
                }
            } catch (error) {
                alert('âš ï¸ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ
        window.addEventListener('load', async () => {
            console.log("ğŸš€ ì†Œ ê´€ë¦¬ ì‹œìŠ¤í…œ ì‹œì‘");

            // Supabase ì—°ê²° í™•ì¸
            await checkSupabaseConnection();

            // ì´ˆê¸° ê°ì§€ ë¡œë“œ
            await loadDetections();

            // ì£¼ê¸°ì ìœ¼ë¡œ ìƒíƒœ í™•ì¸
            setInterval(checkSupabaseConnection, 5000);
            setInterval(updateDetectionCount, 3000);
        });
    </script>
</body>
</html>