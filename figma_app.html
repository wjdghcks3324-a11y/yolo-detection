<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ìƒë‹¨ í—¤ë” */
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .header-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-icon {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-online {
            background: #4CAF50;
        }

        .status-offline {
            background: #f44336;
        }

        /* íƒ­ */
        .tabs-container {
            display: flex;
            gap: 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f0f0f0;
            border: none;
            border-right: 1px solid #e0e0e0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: 0.3s;
        }

        .tab-button:last-child {
            border-right: none;
        }

        .tab-button:hover {
            background: #e8e8e8;
        }

        .tab-button.active {
            background: white;
            color: #2196F3;
            border-bottom: 3px solid #2196F3;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* ì•Œë¦¼ì°½ */
        .alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 14px;
        }

        .alert-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
        }

        .alert-text {
            color: #856404;
            margin-bottom: 10px;
        }

        .alert-code {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }

        /* ì‹¤ì‹œê°„ ì¹´ë©”ë¼ ì„¹ì…˜ */
        .camera-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .camera-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .camera-icon {
            font-size: 18px;
        }

        .camera-container {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-stream {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .camera-placeholder {
            text-align: center;
            color: #999;
        }

        .camera-placeholder-icon {
            font-size: 60px;
            margin-bottom: 10px;
        }

        .camera-placeholder-text {
            font-size: 14px;
            color: #999;
        }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            color: white;
        }

        .btn-sale {
            background: #FF6B6B;
        }

        .btn-sale:hover {
            background: #FF5252;
        }

        .btn-impossible {
            background: #FF0000;
        }

        .btn-impossible:hover {
            background: #CC0000;
        }

        /* ê°ì§€ëª©ë¡ */
        .detection-list {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .list-header {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .message-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f5f5f5;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
            font-size: 13px;
        }

        .message-class {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .message-time {
            font-size: 12px;
            color: #999;
        }

        .message-confidence {
            font-size: 12px;
            color: #666;
        }

        /* í•˜ë‹¨ ë°°ë„ˆ */
        .bottom-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #FFD700;
            color: #333;
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 -1px 3px rgba(0,0,0,0.1);
        }

        .bottom-banner.online {
            background: #4CAF50;
            color: white;
        }

        body {
            padding-bottom: 50px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <div class="header-title">ì†Œ ê´€ë¦¬ ì‹œìŠ¤í…œ ğŸ„</div>
            <div class="status-bar">
                <div class="status-item">
                    ğŸ“Š DB: 4ë§ˆë¦¬
                </div>
                <div class="status-item">
                    <span class="status-icon status-online" id="mounting-status"></span>
                    ê°ì§€: <span id="mounting-count">0</span>ê±´
                </div>
                <div class="status-item">
                    <span class="status-icon status-offline" id="other-status"></span>
                    ë§ˆìš´íŒ…: <span id="other-count">0</span>ê±´
                </div>
            </div>
        </div>

        <!-- íƒ­ ë²„íŠ¼ -->
        <div class="tabs-container">
            <button class="tab-button active" onclick="switchTab('camera')">
                ğŸ“· ì‹¤ì‹œê°„ ì¹´ë©”ë¼
            </button>
            <button class="tab-button" onclick="switchTab('detection')">
                ğŸ“‹ ê°ì§€ëª©ë¡ (0)
            </button>
        </div>

        <!-- ì¹´ë©”ë¼ íƒ­ -->
        <div class="tab-pane active" id="camera-pane">
            <!-- ì—°ê²° ì˜¤ë¥˜ ì•Œë¦¼ -->
            <div id="error-alert" style="display: none;">
                <div class="alert">
                    <div class="alert-title">âš ï¸ Flask ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>
                    <div class="alert-text">
                        PyCharmì—ì„œ detection_streaming_server.pyë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.
                    </div>
                    <div class="alert-code">python detection_streaming_server.py</div>
                    <div class="alert-text">í˜„ì¬ API URL: http://10.9.2.130:5000</div>
                </div>
            </div>

            <!-- ì¹´ë©”ë¼ ì„¹ì…˜ -->
            <div class="camera-section">
                <div class="camera-label">
                    <span class="camera-icon">ğŸ“·</span>
                    ì‹¤ì‹œê°„ ì¹´ë©”ë¼
                </div>

                <div class="camera-container">
                    <img id="camera-stream"
                         class="camera-stream"
                         src="http://10.9.2.130:5000/video_feed"
                         alt="ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼"
                         onerror="showCameraError()">
                </div>

                <div class="button-group">
                    <button class="btn btn-sale" onclick="detectSale()">ğŸ›ï¸ íŒë§¤</button>
                    <button class="btn btn-impossible" onclick="detectImpossible()">âŒ ë¶ˆê°€ëŠ¥</button>
                </div>
            </div>
        </div>

        <!-- ê°ì§€ëª©ë¡ íƒ­ -->
        <div class="tab-pane" id="detection-pane">
            <div class="detection-list">
                <div class="list-header">ğŸ“‹ ê°ì§€ëœ í•­ëª©</div>
                <div id="message-container">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div>ê°ì§€ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ë°°ë„ˆ -->
    <div class="bottom-banner" id="bottom-banner">
        ğŸ”´ Flask ì„œë²„ ë¯¸ì—°ê²° | PyCharmì—ì„œ ì„œë²„ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”
    </div>

    <script>
        // â­ API URL ì„¤ì • (ë‹¹ì‹ ì˜ IP: 10.9.2.130)
        const API_URL = 'http://10.9.2.130:5000';

        let lastMessageId = -1;
        let isConnected = false;

        // íƒ­ ì „í™˜
        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tab + '-pane').classList.add('active');

            if (tab === 'detection') {
                loadMessages();
            }
        }

        // ì¹´ë©”ë¼ ì—ëŸ¬ ì²˜ë¦¬
        function showCameraError() {
            const container = document.querySelector('.camera-container');
            container.innerHTML = `
                <div class="camera-placeholder">
                    <div class="camera-placeholder-icon">ğŸ“·</div>
                    <div class="camera-placeholder-text">ì¹´ë©”ë¼ê°€ êº¼ì ¸ìˆìŠµë‹ˆë‹¤</div>
                </div>
            `;
            document.getElementById('error-alert').style.display = 'block';
        }

        // ì„œë²„ ì—°ê²° í™•ì¸
        async function checkConnection() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    isConnected = true;
                    document.getElementById('bottom-banner').textContent =
                        'âœ… Flask ì„œë²„ ì—°ê²°ë¨ | ì‹¤ì‹œê°„ ê°ì§€ ì¤‘...';
                    document.getElementById('bottom-banner').classList.add('online');
                    document.getElementById('error-alert').style.display = 'none';

                    updateStatus();
                    pollMessages();
                } else {
                    isConnected = false;
                    showConnectionError();
                }
            } catch (error) {
                isConnected = false;
                showConnectionError();
            }
        }

        // ì—°ê²° ì˜¤ë¥˜ í‘œì‹œ
        function showConnectionError() {
            document.getElementById('bottom-banner').textContent =
                'ğŸ”´ Flask ì„œë²„ ë¯¸ì—°ê²° | PyCharmì—ì„œ ì„œë²„ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”';
            document.getElementById('bottom-banner').classList.remove('online');
            document.getElementById('error-alert').style.display = 'block';
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        async function updateStatus() {
            try {
                const response = await fetch(`${API_URL}/status`);
                const data = await response.json();

                document.getElementById('mounting-status').className =
                    'status-icon ' + (data.camera_running ? 'status-online' : 'status-offline');

                document.getElementById('other-status').className =
                    'status-icon ' + (data.messages_count > 0 ? 'status-online' : 'status-offline');

                document.getElementById('mounting-count').textContent = data.messages_count;
            } catch (error) {
                console.error('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }

        // ë©”ì‹œì§€ í´ë§
        async function pollMessages() {
            try {
                const response = await fetch(`${API_URL}/get_latest_message`);

                if (response.status === 204 || !isConnected) {
                    return;
                }

                const data = await response.json();

                if (data.success && data.message.id !== lastMessageId) {
                    lastMessageId = data.message.id;
                    addMessage(data.message);
                }
            } catch (error) {
                console.error('ë©”ì‹œì§€ í´ë§ ì‹¤íŒ¨:', error);
            }
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(message) {
            const container = document.getElementById('message-container');

            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }

            const emoji = message.type === 'realtime' ? 'âš¡' : 'ğŸ“±';
            const item = document.createElement('div');
            item.className = 'message-item';
            item.innerHTML = `
                <div class="message-class">${emoji} ${message.class.toUpperCase()}</div>
                <div class="message-confidence">ì‹ ë¢°ë„: ${message.confidence}%</div>
                <div class="message-time">${message.timestamp}</div>
            `;

            container.insertBefore(item, container.firstChild);

            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        // ëª¨ë“  ë©”ì‹œì§€ ë¡œë“œ
        async function loadMessages() {
            try {
                const response = await fetch(`${API_URL}/get_messages?limit=50`);
                const data = await response.json();

                const container = document.getElementById('message-container');
                container.innerHTML = '';

                if (data.messages.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <div>ê°ì§€ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        </div>
                    `;
                } else {
                    data.messages.reverse().forEach(msg => {
                        const emoji = msg.type === 'realtime' ? 'âš¡' : 'ğŸ“±';
                        const item = document.createElement('div');
                        item.className = 'message-item';
                        item.innerHTML = `
                            <div class="message-class">${emoji} ${msg.class.toUpperCase()}</div>
                            <div class="message-confidence">ì‹ ë¢°ë„: ${msg.confidence}%</div>
                            <div class="message-time">${msg.timestamp}</div>
                        `;
                        container.appendChild(item);
                    });
                }
            } catch (error) {
                console.error('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // íŒë§¤ ê°ì§€
        async function detectSale() {
            try {
                const response = await fetch(`${API_URL}/detect_sale`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();

                if (data.success) {
                    alert(`âœ… íŒë§¤ ê°ì§€ë¨!\nì‹ ë¢°ë„: ${data.confidence}%`);
                    pollMessages();
                    updateStatus();
                } else {
                    alert('âŒ íŒë§¤ë¥¼ ê°ì§€í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                alert('âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
            }
        }

        // ë¶ˆê°€ëŠ¥ ê°ì§€
        async function detectImpossible() {
            try {
                const response = await fetch(`${API_URL}/detect_impossibility`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();

                if (data.success) {
                    alert(`âœ… ë¶ˆê°€ëŠ¥ ê°ì§€ë¨!\nì‹ ë¢°ë„: ${data.confidence}%`);
                    pollMessages();
                    updateStatus();
                } else {
                    alert('âŒ ë¶ˆê°€ëŠ¥ì„ ê°ì§€í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                alert('âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ
        window.addEventListener('load', () => {
            console.log("âœ… ì†Œ ê´€ë¦¬ ì‹œìŠ¤í…œ ì‹œì‘");
            checkConnection();
            setInterval(pollMessages, 2000);
            setInterval(checkConnection, 5000);
            setInterval(updateStatus, 3000);
        });
    </script>
</body>
</html>